import{o as R,n as Y,p as k,q,s as B,j as e,r as _,i as D,A as z,v as V,I as H,k as S,D as P,h as J,m as K,M as Q,P as X,w as Z,x as ee}from"./index-CWKXakZp.js";import{h as se,e as te,b as l}from"./vendor-react-q0iRXJvs.js";import{L as ae}from"./log-out-B1v6aoIS.js";import"./vendor-supabase-DhDedaeW.js";function oe(){const n=se();te();const[x,o]=l.useState(null),[p,h]=l.useState([]),[U,E]=l.useState(!0),[i,C]=l.useState(""),[f,b]=l.useState(!1),[L,j]=l.useState(!1),[w,u]=l.useState(null);l.useEffect(()=>{A();const{data:{subscription:s}}=R(async(t,a)=>{if(t==="SIGNED_IN"&&a?.user){o(a.user);try{await k(a.user.id,a.user.email)}catch(r){console.error("Failed to sync profile:",r)}y(a.user.email),(window.location.hash.includes("access_token")||window.location.hash==="#"||window.location.hash==="#/")&&n("/my-purchases",{replace:!0})}else t==="SIGNED_OUT"&&(o(null),h([]))});return()=>s.unsubscribe()},[n]);const A=async()=>{try{const s=await Y();if(s?.user){o(s.user);try{await k(s.user.id,s.user.email)}catch(t){console.error("Failed to sync profile:",t)}await y(s.user.email)}}catch(s){console.error("Auth check failed:",s)}finally{E(!1)}},y=async s=>{try{const t=await q(s),a=await Promise.all((t||[]).map(async r=>{if(r.type==="gallery"&&r.items?.[0]?.photo?.thumbnail_path){const c=r.items[0].photo.thumbnail_path,{data:d}=await B.storage.from("galleries").createSignedUrl(c,3600);return{...r,thumbnailUrl:d?.signedUrl||null}}return r}));h(a)}catch(t){console.error("Failed to load purchases:",t),u("Failed to load your purchases")}},M=async s=>{if(s.preventDefault(),!!i){b(!0),u(null);try{await Z(i,window.location.origin),j(!0)}catch(t){const a=t?.message||t?.error_description||"Unknown error";u(`Failed to send login link: ${a}`),console.error("Magic link error:",t)}finally{b(!1)}}},$=async()=>{await ee(),o(null),h([])},g=s=>new Date(s).toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short",year:"numeric"}),F=s=>new Date(s).toLocaleTimeString("en-AU",{hour:"2-digit",minute:"2-digit"}),I=s=>{const t=new Date,a=new Date(s.start_time),r=new Date(s.end_time);return t>=a&&t<=r&&s.is_live},T=s=>new Date(s.start_time)>new Date,O=s=>new Date(s.end_time)<new Date;return U?e.jsx("div",{className:"min-h-screen bg-dark-950 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-500"})}):x?e.jsx("div",{className:"min-h-screen bg-dark-950",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsxs("button",{onClick:()=>n("/live"),className:"flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-6",children:[e.jsx(z,{className:"w-5 h-5"}),"Back to Events"]}),e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"My Purchases"}),e.jsx("p",{className:"text-gray-400",children:x.email})]}),e.jsxs("button",{onClick:$,className:"flex items-center gap-2 px-4 py-2 text-gray-400 hover:text-white transition-colors",children:[e.jsx(ae,{className:"w-5 h-5"}),"Sign Out"]})]}),p.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx(_,{className:"w-16 h-16 text-gray-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-white mb-2",children:"No Purchases Yet"}),e.jsx("p",{className:"text-gray-400 mb-6",children:"You haven't purchased any events or photos yet."}),e.jsx("button",{onClick:()=>n("/live"),className:"px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-colors",children:"Browse Events"})]}):e.jsx("div",{className:"space-y-4",children:p.map(s=>{if(s.type==="gallery"){const d=s.gallery,W=s.is_package,N=s.photoCount||0,G=`/gallery/download/${s.download_token}`,m=s.token_expires_at&&new Date(s.token_expires_at)<new Date,v=s.thumbnailUrl||null;return e.jsx("div",{className:"bg-dark-900 rounded-xl border border-dark-800 overflow-hidden hover:border-dark-700 transition-colors",children:e.jsxs("div",{className:"flex flex-col md:flex-row",children:[e.jsx("div",{className:"md:w-48 h-32 md:h-auto flex-shrink-0 bg-gradient-to-br from-purple-900/50 to-pink-900/50 flex items-center justify-center overflow-hidden",children:v?e.jsx("img",{src:v,alt:d?.title||"Photo",className:"w-full h-full object-cover"}):e.jsx(V,{className:"w-16 h-16 text-purple-400/60"})}),e.jsxs("div",{className:"flex-1 p-5",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-1",children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:d?.title||"Photo Gallery"}),e.jsxs("span",{className:"px-2 py-0.5 bg-purple-500/20 text-purple-400 text-xs font-medium rounded-full flex items-center gap-1",children:[e.jsx(H,{className:"w-3 h-3"}),"Photos"]})]}),e.jsx("p",{className:"text-gray-400 text-sm mb-3",children:W?"Full Gallery Package":`${N} photo${N!==1?"s":""}`}),e.jsx("div",{className:"flex flex-wrap gap-4 text-sm text-gray-500",children:m?e.jsxs("div",{className:"flex items-center gap-1 text-amber-500",children:[e.jsx(S,{className:"w-4 h-4"}),"Download link expired"]}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(P,{className:"w-4 h-4"}),"Download available"]})})]}),e.jsxs("button",{onClick:()=>n(G),disabled:m,className:`flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors w-full sm:w-auto ${m?"bg-dark-700 text-gray-500 cursor-not-allowed":"bg-purple-600 hover:bg-purple-700 text-white"}`,children:[e.jsx(P,{className:"w-5 h-5"}),m?"Expired":"Download"]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-dark-800 flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-500",children:["Purchased ",g(s.created_at)]}),e.jsxs("span",{className:"text-green-500 font-medium",children:["$",(s.total_amount/100).toFixed(2)," AUD"]})]})]})]})},s.id)}const t=s.event;if(!t)return null;const a=I(t),r=T(t),c=O(t);return e.jsx("div",{className:"bg-dark-900 rounded-xl border border-dark-800 overflow-hidden hover:border-dark-700 transition-colors",children:e.jsxs("div",{className:"flex flex-col md:flex-row",children:[t.thumbnail_url&&e.jsx("div",{className:"md:w-48 h-32 md:h-auto flex-shrink-0",children:e.jsx("img",{src:J(t.thumbnail_url),alt:t.title,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1 p-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:t.title}),a&&e.jsxs("span",{className:"px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center gap-1",children:[e.jsx("span",{className:"w-1.5 h-1.5 bg-white rounded-full animate-pulse"}),"LIVE"]}),r&&e.jsx("span",{className:"px-2 py-0.5 bg-blue-500/20 text-blue-400 text-xs font-medium rounded-full",children:"Upcoming"}),c&&!t.mux_playback_id&&e.jsx("span",{className:"px-2 py-0.5 bg-gray-500/20 text-gray-400 text-xs font-medium rounded-full",children:"Ended"}),c&&t.mux_playback_id&&e.jsx("span",{className:"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs font-medium rounded-full",children:"Replay Available"})]}),e.jsx("p",{className:"text-gray-400 text-sm mb-3",children:t.org_display_name||t.organization}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(K,{className:"w-4 h-4"}),g(t.start_time)]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"w-4 h-4"}),F(t.start_time)]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Q,{className:"w-4 h-4"}),t.venue]})]})]}),(a||r||t.mux_playback_id)&&e.jsxs("button",{onClick:()=>n(`/watch/${t.id}?email=${encodeURIComponent(x.email)}`),className:`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors flex-shrink-0 ${a?"bg-red-500 hover:bg-red-600 text-white":"bg-dark-800 hover:bg-dark-700 text-white"}`,children:[e.jsx(X,{className:"w-5 h-5"}),a?"Watch Live":r?"Watch":"Replay"]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-dark-800 flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-500",children:["Purchased ",g(s.created_at)]}),e.jsxs("span",{className:"text-green-500 font-medium",children:["$",s.amount," AUD"]})]})]})]})},s.id)})})]})}):e.jsx("div",{className:"min-h-screen bg-dark-950 flex items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md w-full",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx(_,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"My Purchases"}),e.jsx("p",{className:"text-gray-400",children:"Enter your email to access your purchased events"})]}),L?e.jsxs("div",{className:"bg-green-500/10 border border-green-500/30 rounded-xl p-6 text-center",children:[e.jsx(D,{className:"w-12 h-12 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"Check Your Email!"}),e.jsxs("p",{className:"text-gray-400 mb-4",children:["We've sent a login link to ",e.jsx("span",{className:"text-white font-medium",children:i})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Click the link in your email to access your purchases. The link expires in 1 hour."}),e.jsx("button",{onClick:()=>j(!1),className:"mt-4 text-red-500 hover:text-red-400 text-sm",children:"Use a different email"})]}):e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Email Address"}),e.jsx("input",{type:"email",value:i,onChange:s=>C(s.target.value),placeholder:"your@email.com",className:"w-full px-4 py-3 bg-dark-800 border border-dark-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),w&&e.jsx("div",{className:"text-red-500 text-sm",children:w}),e.jsx("button",{type:"submit",disabled:f||!i,className:"w-full py-3 bg-red-500 hover:bg-red-600 disabled:bg-dark-700 disabled:text-gray-500 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"w-5 h-5"}),"Send Login Link"]})}),e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"No password needed! We'll email you a secure login link."})]})]})})}export{oe as default};
