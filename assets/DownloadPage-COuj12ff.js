import{j as e,B as S,C as u,k as C,D as j,I as E}from"./index-y3ibYX3b.js";import{f as A,b as r}from"./vendor-react-q0iRXJvs.js";import{L as f}from"./loader-circle-oSsBd3uO.js";import"./vendor-supabase-DhDedaeW.js";function T(){const{token:c}=A(),[l,y]=r.useState(null),[N,b]=r.useState(!0),[d,v]=r.useState(null),[x,m]=r.useState(null),[h,g]=r.useState(new Set);r.useEffect(()=>{_()},[c]);const _=async()=>{try{const s=await fetch(`https://gonalgubgldgpkcekaxe.supabase.co/functions/v1/gallery_download?token=${c}`),a=await s.json();if(!s.ok)throw new Error(a.error||"Failed to load order");y(a.order);const t=new Set;(a.order.gallery_order_items||a.order.items||[]).forEach(n=>{n.downloaded&&t.add(n.photo_id)}),g(t)}catch(s){console.error("Load order error:",s),v(s.message)}finally{b(!1)}},p=async(s,a)=>{m(s);try{const t=`https://gonalgubgldgpkcekaxe.supabase.co/functions/v1/gallery_download?token=${c}&photo_id=${s}&download=true`,o=document.createElement("a");o.href=t,o.download=a||"photo.jpg",o.target="_blank",document.body.appendChild(o),o.click(),document.body.removeChild(o),g(n=>new Set([...n,s]))}catch(t){console.error("Download error:",t),alert("Download failed: "+t.message)}finally{m(null)}},k=async()=>{const s=l.gallery_order_items||l.items||[];for(const a of s)h.has(a.photo_id)||(await p(a.photo_id,a.gallery_photos?.filename||a.filename||`photo-${a.photo_id}.jpg`),await new Promise(t=>setTimeout(t,500)))};if(N)return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center",children:e.jsx(f,{className:"w-8 h-8 text-red-500 animate-spin"})});if(d)return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx(S,{className:"w-16 h-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:d==="Download link has expired"?"Link Expired":"Access Denied"}),e.jsx("p",{className:"text-gray-400 mb-4",children:d}),d==="Download link has expired"&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Download links expire after 7 days. Please contact us if you need a new link."})]})});const i=l.gallery_order_items||l.items||[],D=i.every(s=>h.has(s.photo_id)),w=new Date(l.token_expires_at),P=Math.ceil((w-new Date)/(1e3*60*60*24));return e.jsx("div",{className:"py-8 px-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(u,{className:"w-8 h-8 text-green-500"})}),e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Your Photos Are Ready!"}),e.jsxs("p",{className:"text-gray-400",children:["Thank you for your purchase from ",l.galleries?.title]})]}),e.jsxs("div",{className:"mb-6 p-4 bg-dark-800 rounded-lg flex items-center gap-3",children:[e.jsx(C,{className:"w-5 h-5 text-yellow-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-300",children:"Downloads available for "}),e.jsxs("span",{className:"text-white font-semibold",children:[P," more days"]}),e.jsxs("span",{className:"text-gray-500 text-sm ml-2",children:["(expires ",w.toLocaleDateString(),")"]})]})]}),i.length>1&&!D&&e.jsxs("button",{onClick:k,disabled:x,className:"w-full mb-6 bg-red-500 hover:bg-red-600 disabled:bg-gray-600 text-white font-semibold py-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[e.jsx(j,{className:"w-5 h-5"}),"Download All (",i.length," photos)"]}),e.jsx("div",{className:"space-y-4",children:i.map(s=>{const a=s.gallery_photos||s,t=s.gallery_photos?.filename||s.filename,o=h.has(s.photo_id),n=x===s.photo_id;return e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4 flex items-center gap-4",children:[e.jsx("div",{className:"w-20 h-20 bg-dark-700 rounded-lg overflow-hidden flex-shrink-0",children:s.thumbnail_url?e.jsx("img",{src:s.thumbnail_url,alt:t||"Photo",className:"w-full h-full object-cover"}):t?e.jsx(E,{className:"w-full h-full text-gray-600 p-4"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-500",children:"No preview"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-white font-medium truncate",children:t||`Photo ${s.photo_id}`}),a?.width&&a?.height&&e.jsxs("p",{className:"text-gray-500 text-sm",children:[a.width," Ã— ",a.height]}),o&&s.download_count>0&&e.jsxs("p",{className:"text-gray-500 text-xs mt-1",children:["Downloaded ",s.download_count," time",s.download_count>1?"s":""]})]}),e.jsx("button",{onClick:()=>p(s.photo_id,t||`photo-${s.photo_id}.jpg`),disabled:n,className:`flex-shrink-0 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${o?"bg-green-600/20 text-green-400 hover:bg-green-600/30":"bg-red-500 hover:bg-red-600 text-white"}`,children:n?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Downloading..."})]}):o?e.jsxs(e.Fragment,{children:[e.jsx(u,{className:"w-4 h-4"}),e.jsx("span",{children:"Download Again"})]}):e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"w-4 h-4"}),e.jsx("span",{children:"Download"})]})})]},s.id)})}),e.jsxs("div",{className:"mt-8 p-6 bg-dark-800 rounded-lg",children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4",children:"Order Details"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Order ID:"}),e.jsx("span",{className:"text-white ml-2 font-mono",children:l.id.slice(0,8)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Total Paid:"}),e.jsxs("span",{className:"text-white ml-2",children:["$",(l.total_amount/100).toFixed(2)," AUD"]})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("span",{className:"text-gray-400",children:"Email:"}),e.jsx("span",{className:"text-white ml-2 break-all",children:l.email})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Date:"}),e.jsx("span",{className:"text-white ml-2",children:new Date(l.completed_at||l.created_at).toLocaleDateString()})]})]})]}),e.jsx("div",{className:"mt-6 text-center text-gray-500 text-sm",children:e.jsx("p",{children:"Having trouble? Contact us at info@fitfocusmedia.com.au"})})]})})}export{T as default};
