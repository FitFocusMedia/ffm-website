import{j as e,z as S,C as j,k as C,D as f,I as A}from"./index-NbYuVc0-.js";import{f as L,b as n}from"./vendor-react-q0iRXJvs.js";import{L as u}from"./loader-circle-Cbrdlty7.js";import"./vendor-supabase-DhDedaeW.js";function R(){const{token:c}=L(),[o,y]=n.useState(null),[N,b]=n.useState(!0),[d,v]=n.useState(null),[h,m]=n.useState(null),[x,g]=n.useState(new Set);n.useEffect(()=>{D()},[c]);const D=async()=>{try{const s=await fetch(`https://gonalgubgldgpkcekaxe.supabase.co/functions/v1/gallery_download?token=${c}`),a=await s.json();if(!s.ok)throw new Error(a.error||"Failed to load order");y(a.order);const t=new Set;a.order.gallery_order_items?.forEach(l=>{l.downloaded&&t.add(l.photo_id)}),g(t)}catch(s){console.error("Load order error:",s),v(s.message)}finally{b(!1)}},p=async(s,a)=>{m(s);try{const t=await fetch(`https://gonalgubgldgpkcekaxe.supabase.co/functions/v1/gallery_download?token=${c}&photo_id=${s}`),l=await t.json();if(!t.ok)throw new Error(l.error||"Download failed");const r=document.createElement("a");r.href=l.download_url,r.download=a,document.body.appendChild(r),r.click(),document.body.removeChild(r),g(E=>new Set([...E,s]))}catch(t){console.error("Download error:",t),alert("Download failed: "+t.message)}finally{m(null)}},_=async()=>{const s=o.gallery_order_items||[];for(const a of s)x.has(a.photo_id)||(await p(a.photo_id,a.gallery_photos?.filename||`photo-${a.photo_id}.jpg`),await new Promise(t=>setTimeout(t,500)))};if(N)return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center",children:e.jsx(u,{className:"w-8 h-8 text-red-500 animate-spin"})});if(d)return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx(S,{className:"w-16 h-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:d==="Download link has expired"?"Link Expired":"Access Denied"}),e.jsx("p",{className:"text-gray-400 mb-4",children:d}),d==="Download link has expired"&&e.jsx("p",{className:"text-gray-500 text-sm",children:"Download links expire after 7 days. Please contact us if you need a new link."})]})});const i=o.gallery_order_items||[],k=i.every(s=>x.has(s.photo_id)),w=new Date(o.token_expires_at),P=Math.ceil((w-new Date)/(1e3*60*60*24));return e.jsx("div",{className:"py-8 px-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(j,{className:"w-8 h-8 text-green-500"})}),e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Your Photos Are Ready!"}),e.jsxs("p",{className:"text-gray-400",children:["Thank you for your purchase from ",o.galleries?.title]})]}),e.jsxs("div",{className:"mb-6 p-4 bg-dark-800 rounded-lg flex items-center gap-3",children:[e.jsx(C,{className:"w-5 h-5 text-yellow-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-300",children:"Downloads available for "}),e.jsxs("span",{className:"text-white font-semibold",children:[P," more days"]}),e.jsxs("span",{className:"text-gray-500 text-sm ml-2",children:["(expires ",w.toLocaleDateString(),")"]})]})]}),i.length>1&&!k&&e.jsxs("button",{onClick:_,disabled:h,className:"w-full mb-6 bg-red-500 hover:bg-red-600 disabled:bg-gray-600 text-white font-semibold py-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[e.jsx(f,{className:"w-5 h-5"}),"Download All (",i.length," photos)"]}),e.jsx("div",{className:"space-y-4",children:i.map(s=>{const a=s.gallery_photos,t=x.has(s.photo_id),l=h===s.photo_id;return e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4 flex items-center gap-4",children:[e.jsx("div",{className:"w-20 h-20 bg-dark-700 rounded-lg overflow-hidden flex-shrink-0",children:a?e.jsx(A,{className:"w-full h-full text-gray-600 p-4"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-500",children:"No preview"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-white font-medium truncate",children:a?.filename||`Photo ${s.photo_id}`}),a&&e.jsxs("p",{className:"text-gray-500 text-sm",children:[a.width," Ã— ",a.height]}),t&&s.download_count>0&&e.jsxs("p",{className:"text-gray-500 text-xs mt-1",children:["Downloaded ",s.download_count," time",s.download_count>1?"s":""]})]}),e.jsx("button",{onClick:()=>p(s.photo_id,a?.filename||`photo-${s.photo_id}.jpg`),disabled:l,className:`flex-shrink-0 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${t?"bg-green-600/20 text-green-400 hover:bg-green-600/30":"bg-red-500 hover:bg-red-600 text-white"}`,children:l?e.jsxs(e.Fragment,{children:[e.jsx(u,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Downloading..."})]}):t?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"w-4 h-4"}),e.jsx("span",{children:"Download Again"})]}):e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"w-4 h-4"}),e.jsx("span",{children:"Download"})]})})]},s.id)})}),e.jsxs("div",{className:"mt-8 p-6 bg-dark-800 rounded-lg",children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4",children:"Order Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Order ID:"}),e.jsx("span",{className:"text-white ml-2 font-mono",children:o.id.slice(0,8)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Email:"}),e.jsx("span",{className:"text-white ml-2",children:o.email})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Total Paid:"}),e.jsxs("span",{className:"text-white ml-2",children:["$",(o.total_amount/100).toFixed(2)," AUD"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Date:"}),e.jsx("span",{className:"text-white ml-2",children:new Date(o.completed_at||o.created_at).toLocaleDateString()})]})]})]}),e.jsx("div",{className:"mt-6 text-center text-gray-500 text-sm",children:e.jsx("p",{children:"Having trouble? Contact us at info@fitfocusmedia.com.au"})})]})})}export{R as default};
